<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>点名系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <style>
        html {
            font-size: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f4f4f9 0%, #e0e0e0 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 2.25rem;
            font-weight: 700;
        }

        button {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            margin: 0.5rem;
            border: none;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 100px;
            min-height: 40px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #startRollCall {
            background-color: #3b82f6;
            color: white;
        }

        #startRollCall:hover {
            background-color: #2563eb;
        }

        #manageNamesBtn {
            background-color: #f59e0b;
            color: white;
        }

        #manageNamesBtn:hover {
            background-color: #d97706;
        }

        #importNamesBtn {
            background-color: #22c55e;
            color: white;
        }

        #importNamesBtn:hover {
            background-color: #16a34a;
        }

        #showHistoryBtn {
            background-color: #6b7280;
            color: white;
        }

        #showHistoryBtn:hover {
            background-color: #4b5563;
        }

        #showLogBtn {
            background-color: #9ca3af;
            color: white;
        }

        #showLogBtn:hover {
            background-color: #6b7280;
        }

        #deleteLogBtn {
            background-color: #ef4444;
            color: white;
        }

        #deleteLogBtn:hover {
            background-color: #dc2626;
        }

        #settingsBtn {
            background-color: #8b5cf6;
            color: white;
        }

        #settingsBtn:hover {
            background-color: #7c3aed;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 0.5rem;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }

        th {
            background-color: #edf2f7;
        }

        input {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            margin: 0.25rem;
        }

        #rollingName {
            font-size: 2rem;
            margin: 1rem 0;
            color: #3b82f6;
            min-height: 2.5rem; /* Ensure consistent height during animation */
        }

        /* Fade animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        #historyModal,
        #logModal,
        #settingsModal {
            display: none;
        }

        @media (max-width: 600px) {
            button {
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>点名系统</h1>
        <div id="rollingName"></div>
        <button id="startRollCall">开始点名</button>
        <button id="manageNamesBtn">管理名单</button>
        <button id="importNamesBtn">导入名字</button>
        <button id="showHistoryBtn">查看历史点名结果</button>
        <button id="showLogBtn">查看日志</button>
        <button id="settingsBtn">设置</button>
        <input type="file" id="nameFileInput" accept=".txt" style="display: none;">
    </div>

    <div id="manageNamesModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>管理名单</h2>
            <button id="addNameBtnInModal">添加名字</button>
            <input type="text" id="newNameInputInModal" placeholder="输入新名字">
            <input type="text" id="searchNameInput" placeholder="搜索名字..." style="width: 100%; margin: 1rem 0;">
            <table id="nameTableInModal">
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>名字</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>历史点名结果</h2>
            <div id="resultList"></div>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>点名日志</h2>
            <div id="logList"></div>
            <button id="deleteLogBtn">删除日志</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>设置</h2>
            <input type="radio" id="importedOnly" name="nameSource" value="imported">
            <label for="importedOnly">只点名导入名字</label><br>
            <input type="radio" id="builtInOnly" name="nameSource" value="builtIn">
            <label for="builtInOnly">只使用内置名字点名</label><br>
            <input type="radio" id="mixed" name="nameSource" value="mixed" checked>
            <label for="mixed">内置加导入名字混合点名</label><br><br>
            <input type="checkbox" id="useLastLogCheckbox">
            <label for="useLastLogCheckbox">使用上一次日志</label>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 内置 40 个名字
            let names = [
                "张三", "李四", "王五", "赵六", "孙七", "周八", "吴九", "郑十",
                "王十一", "李十二", "张十三", "刘十四", "陈十五", "杨十六", "黄十七", "吴十八",
                "林十九", "何二十", "高二十一", "罗二十二", "梁二十三", "宋二十四", "唐二十五", "许二十六",
                "邓二十七", "傅二十八", "沈二十九", "曾三十", "彭三十一", "吕三十二", "苏三十三", "卢三十四",
                "蒋三十五", "蔡三十六", "贾三十七", "丁三十八", "魏三十九", "薛四十"
            ];
            let importedNames = [];

            // 从 localStorage 中获取日志和设置
            let logs = JSON.parse(localStorage.getItem('rollCallLogs')) || [];
            let recentRolls = JSON.parse(localStorage.getItem('recentRolls')) || []; // 存储最近10次点名结果

            const startRollCallBtn = document.getElementById('startRollCall');
            const manageNamesBtn = document.getElementById('manageNamesBtn');
            const importNamesBtn = document.getElementById('importNamesBtn');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const showLogBtn = document.getElementById('showLogBtn');
            const deleteLogBtn = document.getElementById('deleteLogBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            const nameFileInput = document.getElementById('nameFileInput');
            const manageNamesModal = document.getElementById('manageNamesModal');
            const historyModal = document.getElementById('historyModal');
            const logModal = document.getElementById('logModal');
            const settingsModal = document.getElementById('settingsModal');
            const closeManageNamesModalBtn = manageNamesModal.querySelector('.close');
            const closeHistoryModalBtn = historyModal.querySelector('.close');
            const closeLogModalBtn = logModal.querySelector('.close');
            const closeSettingsModalBtn = settingsModal.querySelector('.close');
            const addNameBtnInModal = document.getElementById('addNameBtnInModal');
            const newNameInputInModal = document.getElementById('newNameInputInModal');
            const searchNameInput = document.getElementById('searchNameInput');
            const nameTableInModal = document.getElementById('nameTableInModal');
            const nameTableBodyInModal = nameTableInModal.getElementsByTagName('tbody')[0];
            const rollingName = document.getElementById('rollingName');
            const resultList = document.getElementById('resultList');
            const logList = document.getElementById('logList');
            const useLastLogCheckbox = document.getElementById('useLastLogCheckbox');
            const importedOnlyRadio = document.getElementById('importedOnly');
            const builtInOnlyRadio = document.getElementById('builtInOnly');
            const mixedRadio = document.getElementById('mixed');

            // 加载“使用上一次日志”设置
            useLastLogCheckbox.checked = JSON.parse(localStorage.getItem('useLastLog')) || false;
            useLastLogCheckbox.addEventListener('change', function () {
                localStorage.setItem('useLastLog', JSON.stringify(useLastLogCheckbox.checked));
            });

            // Fisher-Yates 洗牌算法
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // 计算名字在最近10次点名中的出现次数
            function getRecentFrequency(name) {
                return recentRolls.filter(roll => roll === name).length;
            }

            function renderTable() {
                const searchQuery = searchNameInput.value.trim().toLowerCase();
                nameTableBodyInModal.innerHTML = '';
                let allNames = getCurrentNames();
                const filteredNames = allNames.filter(name => name.toLowerCase().includes(searchQuery));
                filteredNames.forEach((name, index) => {
                    const row = document.createElement('tr');
                    const indexCell = document.createElement('td');
                    indexCell.textContent = index + 1;
                    const nameCell = document.createElement('td');
                    nameCell.textContent = name;
                    const actionCell = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '编辑';
                    const originalIndex = allNames.indexOf(name);
                    editBtn.addEventListener('click', () => editName(originalIndex));
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '删除';
                    deleteBtn.addEventListener('click', () => deleteName(originalIndex));
                    actionCell.appendChild(editBtn);
                    actionCell.appendChild(deleteBtn);
                    row.appendChild(indexCell);
                    row.appendChild(nameCell);
                    row.appendChild(actionCell);
                    nameTableBodyInModal.appendChild(row);
                });
            }

            function getCurrentNames() {
                if (importedOnlyRadio.checked) {
                    return importedNames;
                } else if (builtInOnlyRadio.checked) {
                    return names;
                } else {
                    return names.concat(importedNames);
                }
            }

            function startRollCall() {
                let availableNames = [...getCurrentNames()];
                const useLastLog = useLastLogCheckbox.checked;

                // 如果启用“使用上一次日志”，过滤已点名字
                let selectedNamesSet = new Set();
                if (useLastLog && logs.length > 0) {
                    selectedNamesSet = new Set(logs.map(log => log.name));
                    availableNames = availableNames.filter(name => !selectedNamesSet.has(name));
                }

                if (availableNames.length === 0) {
                    if (confirm('所有名字都已被点过，是否重置已点名单？')) {
                        logs = [];
                        localStorage.setItem('rollCallLogs', JSON.stringify(logs));
                        selectedNamesSet.clear();
                        recentRolls = []; // 重置最近点名记录
                        localStorage.setItem('recentRolls', JSON.stringify(recentRolls));
                        availableNames = [...getCurrentNames()];
                    } else {
                        alert('请添加新名字或修改设置。');
                        return;
                    }
                }

                // 打乱名单
                availableNames = shuffle(availableNames);

                // 动态调整动画参数
                const animationSpeed = 300; // 匹配淡入淡出动画时长
                const minCycles = 10;
                const maxCycles = Math.min(20, availableNames.length * 2);
                const totalCycles = Math.floor(Math.random() * (maxCycles - minCycles + 1)) + minCycles;

                let counter = 0;
                let intervalId;

                intervalId = setInterval(() => {
                    // 触发淡出动画
                    rollingName.classList.remove('fade-in');
                    rollingName.classList.add('fade-out');

                    setTimeout(() => {
                        // 更新名字并触发淡入动画
                        const index = Math.floor(Math.random() * availableNames.length);
                        rollingName.textContent = availableNames[index];
                        rollingName.classList.remove('fade-out');
                        rollingName.classList.add('fade-in');
                    }, 150); // 等待淡出动画一半时间

                    counter++;

                    if (counter >= totalCycles) {
                        clearInterval(intervalId);

                        // 选择最终名字，限制最近10次内不超过3次
                        let finalName;
                        let attempts = 0;
                        const maxAttempts = 10; // 防止无限循环
                        do {
                            const finalIndex = Math.floor(Math.random() * availableNames.length);
                            finalName = availableNames[finalIndex];
                            attempts++;
                        } while (getRecentFrequency(finalName) >= 3 && attempts < maxAttempts);

                        // 如果无法找到符合条件的名字，随机选择
                        if (attempts >= maxAttempts) {
                            const finalIndex = Math.floor(Math.random() * availableNames.length);
                            finalName = availableNames[finalIndex];
                        }

                        // 更新界面
                        rollingName.classList.remove('fade-in');
                        rollingName.classList.add('fade-out');
                        setTimeout(() => {
                            rollingName.textContent = finalName;
                            rollingName.classList.remove('fade-out');
                            rollingName.classList.add('fade-in');
                        }, 150);

                        // 更新最近点名记录（滑动窗口，保持10次）
                        recentRolls.push(finalName);
                        if (recentRolls.length > 10) {
                            recentRolls.shift();
                        }
                        localStorage.setItem('recentRolls', JSON.stringify(recentRolls));

                        // 显示结果
                        const resultItem = document.createElement('p');
                        resultItem.textContent = `本次点到的名字是：${finalName}`;
                        resultList.appendChild(resultItem);

                        // 记录日志
                        const now = new Date();
                        const log = {
                            time: now.toLocaleString(),
                            name: finalName
                        };
                        logs.push(log);
                        localStorage.setItem('rollCallLogs', JSON.stringify(logs));
                    }
                }, animationSpeed);
            }

            function openManageNamesModal() {
                manageNamesModal.style.display = 'block';
                searchNameInput.value = '';
                renderTable();
            }

            function closeManageNamesModal() {
                manageNamesModal.style.display = 'none';
            }

            function openHistoryModal() {
                historyModal.style.display = 'block';
            }

            function closeHistoryModal() {
                historyModal.style.display = 'none';
            }

            function openLogModal() {
                logList.innerHTML = '';
                logs.forEach(log => {
                    const logItem = document.createElement('p');
                    logItem.textContent = `${log.time}: 点到的名字是 ${log.name}`;
                    logList.appendChild(logItem);
                });
                logModal.style.display = 'block';
            }

            function closeLogModal() {
                logModal.style.display = 'none';
            }

            function openSettingsModal() {
                settingsModal.style.display = 'block';
            }

            function closeSettingsModal() {
                settingsModal.style.display = 'none';
            }

            function addName() {
                const newName = newNameInputInModal.value.trim();
                if (newName) {
                    if (importedOnlyRadio.checked) {
                        importedNames.push(newName);
                    } else {
                        names.push(newName);
                    }
                    renderTable();
                    newNameInputInModal.value = '';
                }
            }

            function editName(index) {
                let allNames = getCurrentNames();
                const newName = prompt('请输入新的名字', allNames[index]);
                if (newName) {
                    if (importedOnlyRadio.checked) {
                        importedNames[index] = newName;
                    } else if (builtInOnlyRadio.checked) {
                        names[index] = newName;
                    } else {
                        if (index < names.length) {
                            names[index] = newName;
                        } else {
                            importedNames[index - names.length] = newName;
                        }
                    }
                    renderTable();
                }
            }

            function deleteName(index) {
                if (confirm('确定要删除这个名字吗？')) {
                    let allNames = getCurrentNames();
                    if (importedOnlyRadio.checked) {
                        importedNames.splice(index, 1);
                    } else if (builtInOnlyRadio.checked) {
                        names.splice(index, 1);
                    } else {
                        if (index < names.length) {
                            names.splice(index, 1);
                        } else {
                            importedNames.splice(index - names.length, 1);
                        }
                    }
                    renderTable();
                }
            }

            function importNames() {
                nameFileInput.click();
            }

            function deleteLogs() {
                if (confirm('确定要删除所有日志吗？')) {
                    logs = [];
                    recentRolls = []; // 同时清空最近点名记录
                    localStorage.removeItem('rollCallLogs');
                    localStorage.removeItem('recentRolls');
                    logList.innerHTML = '';
                }
            }

            nameFileInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        importedNames = e.target.result.split('\n').map(name => name.trim()).filter(name => name);
                        renderTable();
                    };
                    reader.readAsText(file);
                }
            });

            startRollCallBtn.addEventListener('click', startRollCall);
            manageNamesBtn.addEventListener('click', openManageNamesModal);
            showHistoryBtn.addEventListener('click', openHistoryModal);
            showLogBtn.addEventListener('click', openLogModal);
            settingsBtn.addEventListener('click', openSettingsModal);
            closeManageNamesModalBtn.addEventListener('click', closeManageNamesModal);
            closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
            closeLogModalBtn.addEventListener('click', closeLogModal);
            closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
            addNameBtnInModal.addEventListener('click', addName);
            importNamesBtn.addEventListener('click', importNames);
            deleteLogBtn.addEventListener('click', deleteLogs);
            searchNameInput.addEventListener('input', renderTable);

            window.addEventListener('click', function (event) {
                if (event.target == manageNamesModal) {
                    closeManageNamesModal();
                }
                if (event.target == historyModal) {
                    closeHistoryModal();
                }
                if (event.target == logModal) {
                    closeLogModal();
                }
                if (event.target == settingsModal) {
                    closeSettingsModal();
                }
            });
        });
    </script>
</body>
</html>